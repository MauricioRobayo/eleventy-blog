<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="The successful warrior is the average man, with laser-like focus."
    />
    <title>Mauricio Robayo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-size: 14px;
      }
      * {
        margin: 0;
        color: gainsboro;
      }
      body {
        font-family: "IBM Plex Mono", monospace;
        background-color: darkblue;
        padding: 0.5rem;
      }
      a {
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      h1,
      h2,
      h4 {
        font-size: 1rem;
      }
      h1 {
        margin-bottom: 2rem;
      }
      h2 {
        font-weight: 400;
      }
      h4 {
        margin-top: 1rem;
      }
      ul {
        list-style: none;
        list-style-position: inside;
        padding-left: 0rem;
      }
      .error,
      .error * {
        color: darkred;
      }
      section {
        margin: 2rem 0;
      }
      .repo-loader {
        margin-right: 0.5rem;
      }
      .meta {
        color: darkgray;
      }
      .repo-header > *:not(:last-child) {
        margin-right: 1rem;
      }
      @media screen and (min-width: 768px) {
        :root {
          font-size: 16px;
        }
        body {
          padding: 1rem;
        }
        .repo-header {
          display: flex;
          align-items: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <h1>Mauricio Robayo</h1>
    <ul>
      <li>
        <a
          href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#114;&#102;&#109;&#97;&#106;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;"
          >&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#114;&#102;&#109;&#97;&#106;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a
        >
      </li>
      <li>
        <a href="https://www.linkedin.com/in/mauriciorobayo"
          >https://www.linkedin.com/in/mauriciorobayo</a
        >
      </li>
    </ul>
    <section id="recent-projects"></section>
    <section id="starred-projects"></section>
    <footer>
      <p>No frameworks were harmed in the making of this site.</p>
      <p>Analytics and bloatware free.</p>
      <p>
        Updated:
        <a href="https://youtu.be/dQw4w9WgXcQ?autoplay=1">27 July 1987</a>.
      </p>
    </footer>
    <script>
      loadProjects({
        container: document.getElementById("recent-projects"),
        sort: "updated",
        metaFields: ["language", "updated_at"],
        loader: createLoader(),
      });
      loadProjects({
        container: document.getElementById("starred-projects"),
        sort: "stars",
        metaFields: ["language", "stargazers_count"],
        loader: createLoader(),
      });

      async function loadProjects({
        container,
        sort,
        limit = 3,
        metaFields,
        loader,
      }) {
        const url = `https://api.github.com/search/repositories?q=user:MauricioRobayo&sort=${sort}&per_page=${limit}`;
        const header = createHeader(url, loader);
        container.append(header);

        loader.start();

        const data = await fetchRepos({
          url,
          cache: createCache(`${sort}-${limit}`),
        });

        if (data.error) {
          loader.stop("✗");

          container.classList.add("error");
          container.append(data.message);
        } else {
          loader.stop("✔");

          if (data.cacheHit) {
            const cacheStatus = createCacheStatus(data.expirationTime);
            header.append(cacheStatus);
          } else {
            const rateLimit = createRateLimit(data.rateLimit);
            header.append(...rateLimit);
          }

          const body = createBody();
          const repos = createRepos({
            container: body,
            repos: data.repos,
            metaFields,
          });
          body.append(...repos);
          container.append(body);
        }
      }

      function createRateLimit(rateLimit) {
        return rateLimit.map((info) => {
          const p = document.createElement("p");
          p.textContent = info.join(": ");
          return p;
        });
      }

      function createHeader(url, loader) {
        const header = document.createElement("header");
        const title = document.createElement("h2");
        const link = document.createElement("a");
        link.href = url;
        link.textContent = url;
        title.append(loader.ref, "Fetching ", link);
        header.append(title);

        return header;
      }

      function createBody() {
        const projectsBody = document.createElement("div");
        projectsBody.classList.add("projects-body");

        return projectsBody;
      }

      function createCacheStatus(expirationTime) {
        const container = document.createElement("div");
        container.innerHTML = `
          <p>Cache hit!</p>
          <p>Expires: ${expirationTime}</p>
        `;
        return container;
      }

      function createLoader() {
        let interval = null;
        const element = document.createElement("span");
        element.classList.add("repo-loader");

        return {
          ref: element,
          start: () => {
            const loaderSymbols = ["\\", "|", "/", "—"];
            let i = 0;
            element.textContent = loaderSymbols[i % loaderSymbols.length];
            interval = setInterval(() => {
              console.log("ticking");
              i += 1;
              element.textContent = loaderSymbols[i % loaderSymbols.length];
            }, 500);
          },
          stop: (textContent = "") => {
            clearInterval(interval);
            element.textContent = textContent;
          },
        };
      }

      function createCache(key) {
        return {
          get() {
            const cache = JSON.parse(localStorage.getItem(key));
            if (cache?.expirationTime > Date.now()) {
              return cache;
            }

            return null;
          },
          set(data, expiration = 60 * 60 * 1000) {
            localStorage.setItem(
              key,
              JSON.stringify({
                data,
                expirationTime: Date.now() + expiration,
              })
            );
          },
        };
      }

      function createRepos({ container, repos, metaFields }) {
        return repos.map(
          ({
            name,
            description,
            html_url,
            language,
            stargazers_count,
            updated_at,
          }) => {
            const repoContainer = document.createElement("div");
            const allMetaFields = { language, stargazers_count, updated_at };
            repoContainer.innerHTML = `
              <div class="repo-header">
                <h4>${name}</h4>
                ${createMeta(
                  Object.fromEntries(
                    Object.entries(allMetaFields).filter(([key]) =>
                      metaFields.includes(key)
                    )
                  )
                )}
              </div>
              <div class="repo-body">
                <p>${description || ""}</p>
                <p><a href="${html_url}">${html_url}</p>
              </div>
            `;
            return repoContainer;
          }
        );
      }

      function createMeta(meta) {
        const rtf = new Intl.RelativeTimeFormat("en", { style: "narrow" });

        return Object.entries(meta)
          .map(([key, value]) => {
            if (key === "updated_at") {
              const updatedDate = new Date(value);
              const millisecondsDiff = updatedDate.getTime() - Date.now();
              const daysDiff = Math.floor(
                millisecondsDiff / 1000 / 60 / 60 / 24
              );
              const relativeTime = rtf.format(daysDiff, "day");
              return `<span class="meta">updated ${relativeTime}</span>`;
            }
            if (key === "stargazers_count") {
              return `<span class="meta">${value} stars</span>`;
            }
            return `<span class="meta">${value}</span>`;
          })
          .join("");
      }

      async function fetchRepos({ url, cache }) {
        const cachedData = cache.get();
        if (cachedData) {
          return {
            cacheHit: true,
            expirationTime: cachedData.expirationTime,
            repos: cachedData.data,
          };
        }

        const response = await fetch(url, {
          headers: {
            accept: "application/vnd.github.v3+json",
          },
        });
        const data = await response.json();

        if (!response.ok) {
          return {
            error: response.status,
            message: data.message || response.statusText || "",
          };
        }

        const repos = data.items;

        cache.set(repos);

        return {
          cacheHit: false,
          rateLimit: [...response.headers].filter(([key]) =>
            key.startsWith("x-ratelimit")
          ),
          repos,
        };
      }
    </script>
  </body>
</html>
